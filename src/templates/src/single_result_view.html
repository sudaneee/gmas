{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="{% static 'src/main.css' %}">
    
    <style>
        /* CSS for WeasyPrint/PDF Generation and A4 Formatting */
        @page {
            size: A4;
            margin: 1cm; /* Default margin for A4 */
        }

        /* Ensure each result card starts on a new A4 page */
        .card {
            page-break-after: always;
            margin-bottom: 0 !important;
            border: 1px solid #ccc; /* Add back a light border if preferred in print */
        }
        
        /* Stop the page break after the very last card */
        .card:last-of-type {
            page-break-after: avoid;
        }

        /* Override background image for print media/PDF generation */
        #printarea {
            background: none !important;
        }
        
        /* You might want to remove the image background URL from the body tag for printing */
    </style>

    <title>Examination Report Sheet - {{ f_classs }}</title>
  </head>

  <body id="printarea" style="background: url('{% static 'bg.jpg' %}') no-repeat; background-size: cover;">

    {# The view now passes 'results' as a list of student dictionaries, each including its 'bhv' #}
    {% for result in results %} 

    <div class="card mb-5 shadow">
      <div class="card-header">
        <img style="width: 100%; height: 200px;" src="{{some_images.h_image.url}}">
      </div>
      <div class="card-body">

        <table class="table table-bordered table-sm">
          <thead class="thead-light">
            <tr><th colspan="8" style="text-align: center; font-size: 30px;">Examination Report Sheet</th></tr>
            <tr><th colspan="8" style="text-align: center;">Student Information</th></tr>
            <tr>
              <th style="text-align: center; background-color: white; font-size: 20px;">Name</th>
              <td style="text-align: center; font-size: 20px;">{{result.student}}</td>
              <th style="text-align: center; background-color: white; font-size: 20px;">Class</th>
              <td style="text-align: center; font-size: 20px;">{{result.classs}}</td>
            </tr>
          </thead>
          <tbody>
            <tr>
                {# Use the nested behavioral assessment object (bhv) #}
              <th style="text-align: center; font-size: 20px;">Session</th>
              <td style="text-align: center; font-size: 20px;">{{result.bhv.session}}</td>
              <th style="text-align: center; font-size: 20px;">Term</th>
              <td style="text-align: center; font-size: 20px;">{{result.bhv.term}}</td>
            </tr>
            <tr>
              <th style="text-align: center; font-size: 20px;">No. in Class</th>
              <td style="text-align: center; font-size: 20px;">{{noInClass}}</td>

              {# MODIFICATION: Remove Class Position for Nursery/KG using is_pre_primary flag #}
              {% if not is_pre_primary %}
                <th style="text-align: center; font-size: 20px;">Class Position</th>
                <td style="text-align: center; font-size: 20px;">{{result.c_pos}}</td>
              {% endif %}
            </tr>
            <tr>
              <th style="text-align: center; font-size: 20px;">Gender</th>
              {# Update colspan if Class Position is removed #}
              {% if is_pre_primary %}
                <td colspan="3" style="text-align: center; font-size: 20px;">{{result.student.gender}}</td>
              {% else %}
                <td colspan="1" style="text-align: center; font-size: 20px;">{{result.student.gender}}</td>
              {% endif %}
            </tr>
          </tbody>
        </table>

        <table class="table table-bordered table-sm">
          <thead class="thead-light">
            <tr>
              {# MODIFICATION START: Adjust colspan for Scores title based on is_pre_primary #}
              {% if is_pre_primary %}
                <th colspan="7" style="text-align: center;">Scores</th>
              {% else %}
                <th colspan="8" style="text-align: center;">Scores</th>
              {% endif %}
            </tr>
            <tr>
              <th style="text-align: center; background-color: white;">S/N</th>
              <th style="text-align: center; background-color: white;">Subject</th>
              <th style="text-align: center; background-color: white;">First CA</th>
              <th style="text-align: center; background-color: white;">Second CA</th>
              <th style="text-align: center; background-color: white;">Exam</th>
              <th style="text-align: center; background-color: white;">Total</th>
              <th style="text-align: center; background-color: white;">Grade</th>

              {# MODIFICATION: Remove Position column header for Nursery/KG #}
              {% if not is_pre_primary %}
                <th style="text-align: center; background-color: white;">Position</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for subject in result.subjects %}
            <tr>
              <td style="text-align: center;">{{ forloop.counter }}</td>
              <td>{{ subject.subject }}</td>
              <td style="text-align: center; font-weight: bold;">{{ subject.ca1 }}</td>
              <td style="text-align: center;">{{ subject.ca2 }}</td>
              <td style="text-align: center;">{{ subject.exams }}</td>
              <td style="text-align: center;">{{ subject.total }}</td>

              <td style="text-align: center;">
                {% if subject.total <= 40 %}
                  E
                {% elif subject.total >= 41 and subject.total <= 49 %}
                  D
                {% elif subject.total >= 50 and subject.total <= 59 %}
                  C
                {% elif subject.total >= 60 and subject.total <= 69 %}
                  B
                {% elif subject.total >= 70 and subject.total <= 80 %}
                  A
                {% elif subject.total >= 81 and subject.total <= 100 %}
                  A+
                {% else %}
                  -
                {% endif %}
              </td>

              {# MODIFICATION: Remove Position data cell for Nursery/KG #}
              {% if not is_pre_primary %}
                    {# Use humanize filter if available, otherwise manual check #}
                <td style="text-align: center;">{{ subject.subject_position|default:"-" }}</td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
                {# Adjusted colspan based on is_pre_primary #}
            <tr>
              <td colspan="3" style="text-align: right;">Overall Total:</td>
              <td>{{ result.overal_total }}</td>
              <td style="text-align: right;">Average:</td>
              <td>{{ result.average }}</td>
                {# Fill remaining cells #}
                {% if not is_pre_primary %}
                    <td colspan="2"></td>
                {% else %}
                    <td></td>
                {% endif %}
            </tr>
          </tfoot>
        </table>

        <table class="table table-bordered table-sm">
          <thead>
            <tr><th colspan="8" style="text-align: center;">Behavioural Assessment</th></tr>
            <tr>
              <th style="text-align: center; background-color: white;">Conduct</th>
              <td style="text-align: center;">{{ result.bhv.conduct }}</td>
              <th style="text-align: center; background-color: white;">Punctuality</th>
              <td style="text-align: center;">{{ result.bhv.punctuality }}</td>
              <th style="text-align: center; background-color: white;">Dedication</th>
              <td style="text-align: center;">{{ result.bhv.dedication }}</td>
              <th style="text-align: center; background-color: white;">Participation</th>
              <td style="text-align: center;">{{ result.bhv.participation }}</td>
            </tr>
            <tr>
              <th style="text-align: center; background-color: white;">Hospitality</th>
              <td style="text-align: center;">{{ result.bhv.hospitality }}</td>
              <th style="text-align: center; background-color: white;">Neatness</th>
              <td style="text-align: center;">{{ result.bhv.neatness }}</td>
              <th style="text-align: center; background-color: white;">Creativity</th>
              <td style="text-align: center;">{{ result.bhv.creativity }}</td>
              <th style="text-align: center; background-color: white;">Physical Health</th>
              <td style="text-align: center;">{{ result.bhv.physical }}</td>
            </tr>
            <tr>
              <th style="text-align: center; background-size: cover; background-color: white;">Days Opened</th>
              <td style="text-align: center;">{{ result.bhv.school_opened }}</td>
              <th style="text-align: center; background-color: white;">Days Present</th>
              <td style="text-align: center;">{{ result.bhv.days_present }}</td>
              <th style="text-align: center; background-color: white;">Days Absent</th>
              <td style="text-align: center;">{{ result.bhv.days_absent }}</td>
              <th style="text-align: center; background-color: white;">Resumption Date</th>
              <td style="text-align: center;">{{ result.bhv.next_date_of_resumption }}</td>
            </tr>
          </thead>
          <img style="height:200px; width: 100%;" src="{{some_images.g_image.url}}">
        </table>

        <table class="table table-bordered table-sm">
          <tbody>
            <tr>
              <td style="text-align: center; width: 30%;">General Comment:</td>
              {% if result.average <= 40 %}
                <td style="text-align: center;">Well done, put more effort.</td>
              {% elif result.average >= 41 and result.average <= 49 %}
                <td style="text-align: center;">Well done, put more effort.</td>
              {% elif result.average >= 50 and result.average <= 59 %}
                <td style="text-align: center;">Don't relent in your studies, you can do better.</td>
              {% elif result.average >= 60 and result.average <= 69 %}
                <td style="text-align: center;">A very good performance.</td>
              {% elif result.average >= 70 and result.average <= 80 %}
                <td style="text-align: center;">A brilliant performance, keep it up.</td>
              {% elif result.average >= 81 and result.average <= 100 %}
                <td style="text-align: center;">Bravo! An outstanding and excellent performance, keep it up.</td>
              {% else %}
                <td style="text-align: center;">Invalid score.</td>
              {% endif %}
            </tr>
          </tbody>
        </table>

        <table class="table table-bordered table-sm" style="margin-top: 20px;">
          <tbody>
            <tr>
                {# Signature space for Class Teacher / Form Master #}
              <td style="text-align: center; width: 33%;">
                    {% if signs.t_image %}
                        <img style="height: 50px; width: 150px; object-fit: contain;" src="{{ signs.t_image.url }}">
                    {% else %}
                        <div style="height: 50px;"></div>
                    {% endif %}
                </td>

              <td style="text-align: center; width: 33%;">{{date|date:"d-m-Y"}}</td>

                {# Signature space for Head Teacher / Principal #}
              <td style="text-align: center; width: 33%;">
                    {% if signs.p_image %}
                        <img style="height: 50px; width: 150px; object-fit: contain;" src="{{ signs.p_image.url }}">
                    {% else %}
                        <div style="height: 50px;"></div>
                    {% endif %}
                </td>
            </tr>
            <tr>
                {# Dynamic Label 1 #}
              <td style="text-align: center; border-top: none;">
                {% if is_pre_primary %}
                  Class Teacher's Signature
                {% else %}
                  Form Master's Signature
                {% endif %}
              </td>

              <td style="text-align: center; border-top: none;">Date</td>

                {# Dynamic Label 2 #}
              <td style="text-align: center; border-top: none;">
                {% if is_pre_primary %}
                  Head Teacher's Signature
                {% else %}
                  Principal's Signature
                {% endif %}
              </td>
            </tr>
          </tbody>
        </table>

      </div>
    </div>

    {# End of the result loop #}
    {% endfor %} 

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>